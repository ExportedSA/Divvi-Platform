// This is Prisma schema for SQLite local development
// Copy this content to schema.prisma when using SQLite

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String
  name              String?
  role              UserRole  @default(RENTER)
  farmName          String?
  farmSize          Float?
  farmLocation      String?
  avatar            String?
  bio               String?
  phone             String?
  emailVerified     DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  listings          Listing[]
  bookingsAsRenter  Booking[] @relation("RenterBookings")
  bookingsAsOwner   Booking[] @relation("OwnerBookings")
  reviewsGiven      Review[]  @relation("ReviewsGiven")
  reviewsReceived   Review[]  @relation("ReviewsReceived")
  messagesSent      Message[]
  conversations     Conversation[] @relation("UserConversations")
  notifications     Notification[]
  policyAcknowledgements PolicyAcknowledgement[]

  @@map("users")
}

model Listing {
  id                  String       @id @default(cuid())
  ownerId             String
  title               String
  description         String
  category            EquipmentCategory
  brand               String
  model               String
  year                Int
  enginePowerHP       Int?
  workingWidth        Float?
  capacity            String?
  condition           String
  features            String[]
  pricePerDay         Float
  pricePerWeek        Float?
  minimumRentalDays   Int          @default(1)
  bondAmount          Float
  location            String
  photos              String[]
  status              ListingStatus @default(DRAFT)
  averageRating       Float?
  totalReviews        Int          @default(0)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  // Relations
  owner               User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  bookings            Booking[]
  reviews             Review[]
  availabilityBlocks  AvailabilityBlock[]
  maintenanceRecords  MaintenanceRecord[]

  @@map("listings")
}

model Booking {
  id                   String        @id @default(cuid())
  listingId            String
  renterId             String
  ownerId              String
  startDate            DateTime
  endDate              DateTime
  status               BookingStatus @default(PENDING)
  rentalTotal          Float
  bondAmountAtBooking  Float
  notes                String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  // Relations
  listing              Listing       @relation(fields: [listingId], references: [id], onDelete: Cascade)
  renter               User          @relation("RenterBookings", fields: [renterId], references: [id], onDelete: Cascade)
  owner                User          @relation("OwnerBookings", fields: [ownerId], references: [id], onDelete: Cascade)
  reviews              Review[]
  messages             Message[]

  @@map("bookings")
}

model Review {
  id          String     @id @default(cuid())
  bookingId   String
  reviewerId  String
  revieweeId  String
  rating      Int        @default(5)
  comment     String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  booking     Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  reviewer    User       @relation("ReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee    User       @relation("ReviewsReceived", fields: [revieweeId], references: [id], onDelete: Cascade)

  @@unique([bookingId, reviewerId])
  @@map("reviews")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  type           MessageType @default(TEXT)
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  booking        Booking?

  @@map("messages")
}

model Conversation {
  id            String   @id @default(cuid())
  participantA  String
  participantB  String
  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  participants  User[]   @relation("UserConversations")
  messages      Message[]
  bookingId     String?  @unique

  @@map("conversations")
}

model AvailabilityBlock {
  id        String   @id @default(cuid())
  listingId String
  startDate DateTime
  endDate   DateTime
  reason    String?
  createdAt DateTime @default(now())

  // Relations
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@map("availability_blocks")
}

model MaintenanceRecord {
  id          String   @id @default(cuid())
  listingId   String
  date        DateTime
  type        String
  description String
  cost        Float?
  createdAt   DateTime @default(now())

  // Relations
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@map("maintenance_records")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  data      Json?            // Additional data related to the notification
  createdAt DateTime         @default(now())

  // Relations
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Policy {
  id          String   @id @default(cuid())
  title       String
  content     String
  version     String   @unique
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  acknowledgements PolicyAcknowledgement[]

  @@map("policies")
}

model PolicyAcknowledgement {
  id         String   @id @default(cuid())
  userId     String
  policyId   String
  acknowledgedAt DateTime @default(now())

  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  policy     Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([userId, policyId])
  @@map("policy_acknowledgements")
}

// Enums
enum UserRole {
  OWNER
  RENTER
  ADMIN
}

enum EquipmentCategory {
  TRACTOR
  HARVESTER
  PLOUGH
  SEEDER
  SPRAYER
  IRRIGATION
  TILLAGE
  BALER
  LOADER
  OTHER
}

enum ListingStatus {
  DRAFT
  LIVE
  RENTED
  MAINTENANCE
  INACTIVE
}

enum BookingStatus {
  PENDING
  ACCEPTED
  ACTIVE
  COMPLETED
  CANCELLED
  REJECTED
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum NotificationType {
  BOOKING_REQUEST
  BOOKING_ACCEPTED
  BOOKING_REJECTED
  BOOKING_CANCELLED
  MESSAGE_RECEIVED
  REVIEW_RECEIVED
  PAYMENT_REQUIRED
  EQUIPMENT_RETURNED
  POLICY_UPDATE
}
